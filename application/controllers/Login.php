<?php
defined('BASEPATH') OR exit('No direct script access allowed');
class Login extends CI_Controller
{
	 public function __construct()
    {
        parent::__construct();
        $this->load->view('theme/header');
    }
    public function index()
	{
		if (null!==($this->session->userdata('identifiant'))) {
            // si on a une session avec identifiant d'ouverte 
        }
		else
		{// si pas de session, page de login
			// on prépare le terrain en metant des form_validation pour êter sur qu'il rentre bien des bonne donées dans page login
		$this->load->model('users_model');
        $identifiant = $this->input->post('identifiant');
        $password = $this->input->post('password');
        $result= $this->users_model->login_user($identifiant,$password);	
        $this->form_validation->set_rules('identifiant', '"Identifiant"', 'trim|required',
                                            array(  'required'=>'%s est requis .',
                                                    ));
        $this->form_validation->set_rules('password', '"Mot de passe"', 'trim|required',
                                            array('required'=>'%s est requis .'));
        
        if ($this->form_validation->run() == FALSE)
            {// si validation en erreur on le renvoi ver la page login
                $this->page_connexion();
            }
        elseif ($this->form_validation->run() == true && empty($result)) 
            {	//si validation OK mais que le modèle renvoi un résultat vide( ce qui veut que pas d'occurence dans BDD)
                
                $this->erreur_connexion();
            }
        else
            {
                $this->session->set_userdata('identifiant', $result[0]->identifiant);
                $this->session->set_userdata('prenom', $result[0]->prenom);
                $this->session->set_userdata('nom', $result[0]->nom);
                redirect('option21');
            }
		}
	}
    
	public function page_connexion()
	{

		$this->load->view('users/connexion');
	}
	public function logout()
    {
        $this->session->sess_destroy();
        redirect('login');
                
    }
    public function erreur_connexion()
    {
        $this->load->model('users_model');
        $identifiant = $this->input->post('identifiant');
        $password = $this->input->post('password');
        //on charge modèle qui verifie si email existe
        $result_connexion= $this->users_model->erreur_connexion($identifiant,$password);
        //ternaire sur connexion (via password) vide alors password inconue sinon login iconnu
        // on verifie vide car si modèle ne retourne rien de la bdd il retourne un empty
         $erreur=array();
        empty($result_connexion) ? $erreur['error']='Mod de passe inconnu' : $erreur['error']="Mot de passe invalide" ;
        
        $this->load->view('users/connexion',$erreur);// on renvoi vers pas connexion + erreur dans attribut
    }

}