<?php
defined('BASEPATH') OR exit('No direct script access allowed');
class Option21 extends CI_Controller
{
	 public function __construct()
    {
        parent::__construct();
        $this->load->view('theme/header');
        $this->load->model('option21_model');
    }
    public function index()
    {
    	if (null!==($this->session->userdata('identifiant'))) {
            // si on a une session avec identifiant d'ouverte
            $data=array();
            $data['liste_option21']=$this->option21_model->listing_option21_planifier();
            $data['en_cours']=$this->option21_model->listing_option21_en_cours();
            $this->load->view('option21/apercu',$data);          
            $data['planif_a_faire']=$this->option21_model->planif_a_faire();
            $this->load->view('option21/planif_a_faire',$data);            
            $data['historique']=$this->option21_model->listing_option21_historique();
            $this->load->view('option21/historique',$data);
        }
		else
		{
			redirect('login');
		}
    }
    public function planification()
    { //création des options 21 
        $this->load->model('machines_model');
        $data=array();
        // on envoi la liste de toutes les machines également pour selectioner la machine sur laquel on va créer l'option21
        $data['nom_machines']=$this->machines_model->afficher_liste_nom_machine();
        $this->load->view('option21/planification',$data);
    }
    public function planification_prerempli()
    { //création des options 21 
        $data=array();
        $data['machines']=$this->input->post('machines');
        $data['jeu']=$this->input->post('jeu_a_utiliser');
        $data['id_machines']=$this->input->post('id_machines');;
    	$this->load->view('option21/planification_prerempli',$data);
    }
    public function creation()
    {
    	$jeu=intval($this->input->post('jeu'));
        //comme j'ai choisi une balise select, il renvoit automatiquement en string , ce que je ne veux pas puisque j'inser dans bdd du int
        //du coup je vais intval($this...) pour convertir en int
    	$machines=$this->input->post('id_machines');
    	$date_planif=$this->input->post('date_planification');
        $identifiant=$this->session->userdata('identifiant');
        $this->form_validation->set_rules('date_planification', 'Date de planification', 'required',
                                                    array(  'required'=>'%s est requis .',));
        if ($this->form_validation->run()==true)
        {
            $this->option21_model->insertion_option21($jeu,$machines,$date_planif,$identifiant);
            redirect('option21');
        }
        else
        {
            $this->planification();
        }
    }
    public function supprimer_option21($id)
    {
        $id_option21=$id;
        $this->option21_model->suppression_option21($id_option21);
        redirect('option21');
    }
    public function start_option21($id)
    {
        $id_option21=$id;
        $this->option21_model->start_option21($id_option21);
        redirect('option21');
    }
    public function fin_option21($id)
    {   
        //$id qui passe en GET
        // on recupère le commentaire via input 
        // on test quel bouton
        // bouton nommé dans le form html
        // on a reçu si bOK, c'es que OPT21 s'est fini OK
        // du coup on déplanifie en plus les options 21 qui datent de plus de  6 mois. 
        //si on reçoit berreur , c'est que option21 en erreur de fait on passe en statu erreur
        $id_option21=$id;
        $commentaire=$this->input->post('commentaire');
        if (null !==($this->input->post('bOK')))
        {
            $this->option21_model->fin_ok_option21($id_option21,$commentaire);
            $id_machines=$this->input->post('id_machines');
            $this->option21_model->deplanification_option21($id_machines);
            redirect('option21');
        }
        elseif (null !==($this->input->post('berreur'))) {
            $this->option21_model->fin_erreur_option21($id_option21,$commentaire);
            redirect('option21');
        }
        else
        {
            redirect('option21');
        }
    }

}