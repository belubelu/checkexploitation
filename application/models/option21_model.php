<?php  if ( ! defined('BASEPATH')) exit('No direct script access allowed');

class Option21_model extends CI_Model
{
	protected $table='option21';

	public function insertion_option21($jeu,$id_machines,$date_planif,$identifiant)
	{// creation d'une option 21 
		
		return $this->db->set('jeu', $jeu)
			->set('id_machines',$id_machines)
			->set('date_planification',$date_planif)
			->set('identifiant',$identifiant)
			->set('statut','p')
			->insert($this->table);
	}
	public function listing_option21_planifier()
	{ ///req pour afficher les options 21 qui sont prévu
		$resultat =$this->db->select('*')
							->from($this->table)
							->join('machines','option21.id_machines=machines.id_machines')
							->join('users','option21.identifiant=users.identifiant')
							->where('statut','p')
							->get()
							->result();
		return $resultat;
	}
	public function listing_option21_en_cours()
	{ //req pour afficher les options qui sont en cours
		$resultat =$this->db->select('*')
							->from($this->table)
							->join('machines','option21.id_machines=machines.id_machines')
							->join('users','option21.identifiant=users.identifiant')
							->where('statut','c')
							->get()
							->result();
		return $resultat;
	}
	public function listing_option21_historique()
	{//req avec jointure sur idmachine et identifiant pour afficher l"historique complet des options 21 réalisés
		$resultat =$this->db->select('*')
							->from($this->table)
							->join('machines','option21.id_machines=machines.id_machines')
							->join('users','option21.identifiant=users.identifiant')
							->where('statut','t')
							->or_where('statut','e')
							->order_by('option21.id_opt21','DESC')
							->get()
							->result();
		return $resultat;
	}
	public function suppression_option21($id)
	{
		return $this->db ->where('id_opt21',$id)
						-> delete($this->table);
	}
	public function start_option21($id)
	{	
		$today = date("Y-m-d H:i:s");
		$resultat= $this->db->set('statut', 'c')
					->set('date_debut',$today)
					->where('id_opt21',$id)
					->update($this->table);
	}
	public function fin_ok_option21($id,$commentaire)
	{	
		$today = date("Y-m-d H:i:s");
		$resultat= $this->db->set('statut', 't')
					->set('date_fin',$today)
					->set('prochaine_planif','o')
					->set('commentaire',$commentaire)
					->where('id_opt21',$id)
					->update($this->table);
	}
	
	public function fin_erreur_option21($id,$commentaire)
	{	
		$today = date("Y-m-d H:i:s");
		$resultat= $this->db->set('statut', 'e')
					->set('date_fin',$today)
					->set('commentaire',$commentaire)
					->where('id_opt21',$id)
					->update($this->table);
	}

	public function planif_a_faire()
	{// requete qui va selectionner les machines qui ont fait leurs denrière option12  il y'a plus de 6 mois , avec un statut terminé et le flag à faire ( prochaine_planif à o )avec une jointure sur les id des machines pour avoir nom dns des machines
		$resultat =$this->db->select()
							->from($this->table)
							->join('machines','option21.id_machines=machines.id_machines')
							->where('prochaine_planif','o')
							->where('statut','t')
							->where('DATEDIFF(NOW(),date_fin) > 180')
							->get()
							->result();
		return $resultat;
	}
	public function deplanification_option21($id_machines)
	{// lorsqu'on a passé une option 21 en terminé , cette requete va mettre à jour le flag de la denrière option faite de cette machine il y a plus de 6 mois( prochaine_planif à n)
		$deplanification_derniere_option21=$this->db->set('prochaine_planif', 'n')
													->where('prochaine_planif','o')
													->where('statut','t')
													->where('DATEDIFF(NOW(),date_fin) > 180')
													->where('id_machines',$id_machines)
													->update($this->table);
		return $deplanification_derniere_option21;

	}
}